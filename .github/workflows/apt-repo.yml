name: Build and Deploy APT Repository

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Clona el repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- ⬇️ PASO CORREGIDO (VERSIÓN FINALÍSIMA) ⬇️ ---
      # 2. Inicia y Configura GPG Agent
      - name: Start and Configure GPG Agent
        run: |
          # 1. Inicia el daemon. Esto crea ~/.gnupg
          gpg-agent --daemon
          
          # 2. Escribe los archivos de configuración
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf
          
          # 3. Recarga el agente (que ahora SÍ está corriendo)
          gpg-connect-agent reloadagent /bye
      # --- ⬆️ FIN DEL PASO CORREGIDO ⬆️ ---

      # 3. Construye el repositorio
      - name: Build APT repository
        uses: morph027/apt-repo-action@v3.7
        with:
          # ❗️ Asegúrate que este sea tu repo-name (ej. kronos)
          repo-name: 'kronos'
          
          suite: 'stable' 
          components: 'main'
          architectures: 'amd64'

          # Lee los secrets
          signing-key: ${{ secrets.GPG_PRIVATE_KEY }}
          signing-key-passphrase: ${{ secrets.GPG_PASSPHRASE }}

      # 4. Publica en GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: repo
